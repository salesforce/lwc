/*
 * Copyright (c) 2018, salesforce.com, inc.
 * All rights reserved.
 * SPDX-License-Identifier: MIT
 * For full license text, see the LICENSE file in the repo root or https://opensource.org/licenses/MIT
 */

/**
 * Whenever we extend a global native constructor that is of type "object" in IE11 (e.g., NodeList, HTMLCollection,
 * etc), this results in compiled code that throws in IE11 because the compiled code (rightly) expects that the
 * constructor is of type "function". We decided not to use the obvious workaround of prototypical inheritance because
 * we want the type-checking we get from using "extends".
 *
 * https://github.com/babel/babel/blob/0514a9f90370b2c14bcd722f96fd97644024f9fd/packages/babel-helpers/src/helpers.js#L506
 */

/**
 * This rule is complimentary to no-extend-native in that it prevents us from using the
 * `extend` keyword on any of the mentioned global constructors
 * https://eslint.org/docs/rules/no-extend-native
 */
/**
 * These global identifiers were taken from:
 * https://github.com/sindresorhus/globals/blob/3341b4df701c0f7911bfb2c8064b2bb5d11d6f6a/globals.json
 *
 * The following filters were applied:
 * - Begins with an uppercase letter
 * - Typeof "object" in IE11
 * - Typeof "function" in Chrome
 */
const ILLEGAL_GLOBAL_OBJECTS = new Set([
    'AnimationEvent',
    'Attr',
    'BeforeUnloadEvent',
    'CSSFontFaceRule',
    'CSSImportRule',
    'CSSKeyframeRule',
    'CSSKeyframesRule',
    'CSSMediaRule',
    'CSSNamespaceRule',
    'CSSPageRule',
    'CSSRule',
    'CSSRuleList',
    'CSSStyleDeclaration',
    'CSSStyleRule',
    'CSSStyleSheet',
    'CanvasGradient',
    'CanvasPattern',
    'CanvasRenderingContext2D',
    'CharacterData',
    'CloseEvent',
    'Comment',
    'CompositionEvent',
    'Crypto',
    'CustomEvent',
    'DOMError',
    'DOMException',
    'DOMImplementation',
    'DOMStringList',
    'DOMStringMap',
    'DOMTokenList',
    'DataTransfer',
    'DeviceMotionEvent',
    'DeviceOrientationEvent',
    'Document',
    'DocumentFragment',
    'DocumentType',
    'DragEvent',
    'Element',
    'ErrorEvent',
    'Event',
    'File',
    'FileList',
    'FocusEvent',
    'HTMLAllCollection',
    'HTMLAnchorElement',
    'HTMLAreaElement',
    'HTMLAudioElement',
    'HTMLBRElement',
    'HTMLBaseElement',
    'HTMLBodyElement',
    'HTMLButtonElement',
    'HTMLCanvasElement',
    'HTMLCollection',
    'HTMLDListElement',
    'HTMLDataListElement',
    'HTMLDirectoryElement',
    'HTMLDivElement',
    'HTMLDocument',
    'HTMLElement',
    'HTMLEmbedElement',
    'HTMLFieldSetElement',
    'HTMLFontElement',
    'HTMLFormElement',
    'HTMLFrameElement',
    'HTMLFrameSetElement',
    'HTMLHRElement',
    'HTMLHeadElement',
    'HTMLHeadingElement',
    'HTMLHtmlElement',
    'HTMLIFrameElement',
    'HTMLImageElement',
    'HTMLInputElement',
    'HTMLLIElement',
    'HTMLLabelElement',
    'HTMLLegendElement',
    'HTMLLinkElement',
    'HTMLMapElement',
    'HTMLMarqueeElement',
    'HTMLMediaElement',
    'HTMLMenuElement',
    'HTMLMetaElement',
    'HTMLModElement',
    'HTMLOListElement',
    'HTMLObjectElement',
    'HTMLOptGroupElement',
    'HTMLOptionElement',
    'HTMLParagraphElement',
    'HTMLParamElement',
    'HTMLPreElement',
    'HTMLProgressElement',
    'HTMLQuoteElement',
    'HTMLScriptElement',
    'HTMLSelectElement',
    'HTMLSourceElement',
    'HTMLSpanElement',
    'HTMLStyleElement',
    'HTMLTableCaptionElement',
    'HTMLTableCellElement',
    'HTMLTableColElement',
    'HTMLTableElement',
    'HTMLTableRowElement',
    'HTMLTableSectionElement',
    'HTMLTextAreaElement',
    'HTMLTitleElement',
    'HTMLTrackElement',
    'HTMLUListElement',
    'HTMLUnknownElement',
    'HTMLVideoElement',
    'History',
    'IDBCursor',
    'IDBCursorWithValue',
    'IDBDatabase',
    'IDBFactory',
    'IDBIndex',
    'IDBKeyRange',
    'IDBObjectStore',
    'IDBOpenDBRequest',
    'IDBRequest',
    'IDBTransaction',
    'IDBVersionChangeEvent',
    'ImageData',
    'KeyboardEvent',
    'Location',
    'MediaError',
    'MediaList',
    'MediaQueryList',
    'MessageEvent',
    'MessagePort',
    'MimeType',
    'MimeTypeArray',
    'MouseEvent',
    'MutationEvent',
    'MutationRecord',
    'NamedNodeMap',
    'Navigator',
    'Node',
    'NodeFilter',
    'NodeIterator',
    'NodeList',
    'PageTransitionEvent',
    'Performance',
    'PerformanceEntry',
    'PerformanceMark',
    'PerformanceMeasure',
    'PerformanceNavigation',
    'PerformanceNavigationTiming',
    'PerformanceResourceTiming',
    'PerformanceTiming',
    'Plugin',
    'PluginArray',
    'PointerEvent',
    'PopStateEvent',
    'ProcessingInstruction',
    'ProgressEvent',
    'Range',
    'SVGAElement',
    'SVGAngle',
    'SVGAnimatedAngle',
    'SVGAnimatedBoolean',
    'SVGAnimatedEnumeration',
    'SVGAnimatedInteger',
    'SVGAnimatedLength',
    'SVGAnimatedLengthList',
    'SVGAnimatedNumber',
    'SVGAnimatedNumberList',
    'SVGAnimatedPreserveAspectRatio',
    'SVGAnimatedRect',
    'SVGAnimatedString',
    'SVGAnimatedTransformList',
    'SVGCircleElement',
    'SVGClipPathElement',
    'SVGComponentTransferFunctionElement',
    'SVGDefsElement',
    'SVGDescElement',
    'SVGElement',
    'SVGEllipseElement',
    'SVGFEBlendElement',
    'SVGFEColorMatrixElement',
    'SVGFEComponentTransferElement',
    'SVGFECompositeElement',
    'SVGFEConvolveMatrixElement',
    'SVGFEDiffuseLightingElement',
    'SVGFEDisplacementMapElement',
    'SVGFEDistantLightElement',
    'SVGFEFloodElement',
    'SVGFEFuncAElement',
    'SVGFEFuncBElement',
    'SVGFEFuncGElement',
    'SVGFEFuncRElement',
    'SVGFEGaussianBlurElement',
    'SVGFEImageElement',
    'SVGFEMergeElement',
    'SVGFEMergeNodeElement',
    'SVGFEMorphologyElement',
    'SVGFEOffsetElement',
    'SVGFEPointLightElement',
    'SVGFESpecularLightingElement',
    'SVGFESpotLightElement',
    'SVGFETileElement',
    'SVGFETurbulenceElement',
    'SVGFilterElement',
    'SVGGElement',
    'SVGGradientElement',
    'SVGImageElement',
    'SVGLength',
    'SVGLengthList',
    'SVGLineElement',
    'SVGLinearGradientElement',
    'SVGMarkerElement',
    'SVGMaskElement',
    'SVGMatrix',
    'SVGMetadataElement',
    'SVGNumber',
    'SVGNumberList',
    'SVGPathElement',
    'SVGPatternElement',
    'SVGPoint',
    'SVGPointList',
    'SVGPolygonElement',
    'SVGPolylineElement',
    'SVGPreserveAspectRatio',
    'SVGRadialGradientElement',
    'SVGRect',
    'SVGRectElement',
    'SVGSVGElement',
    'SVGScriptElement',
    'SVGStopElement',
    'SVGStringList',
    'SVGStyleElement',
    'SVGSwitchElement',
    'SVGSymbolElement',
    'SVGTSpanElement',
    'SVGTextContentElement',
    'SVGTextElement',
    'SVGTextPathElement',
    'SVGTextPositioningElement',
    'SVGTitleElement',
    'SVGTransform',
    'SVGTransformList',
    'SVGUnitTypes',
    'SVGUseElement',
    'SVGViewElement',
    'Screen',
    'Selection',
    'SourceBuffer',
    'SourceBufferList',
    'Storage',
    'StorageEvent',
    'StyleSheet',
    'StyleSheetList',
    'SubtleCrypto',
    'Text',
    'TextEvent',
    'TextMetrics',
    'TextTrack',
    'TextTrackCueList',
    'TextTrackList',
    'TimeRanges',
    'TrackEvent',
    'TransitionEvent',
    'TreeWalker',
    'UIEvent',
    'URL',
    'ValidityState',
    'WebGLActiveInfo',
    'WebGLBuffer',
    'WebGLFramebuffer',
    'WebGLProgram',
    'WebGLRenderbuffer',
    'WebGLRenderingContext',
    'WebGLShader',
    'WebGLShaderPrecisionFormat',
    'WebGLTexture',
    'WebGLUniformLocation',
    'WheelEvent',
    'Window',
    'XMLDocument',
    'XMLHttpRequestEventTarget',
]);

module.exports = {
    meta: {
        type: 'problem',
        docs: {
            description: 'Avoids directly extending global constructors.',
        },
    },

    create(context) {
        return {
            'ClassDeclaration, ClassExpression'(node) {
                if (
                    node.superClass &&
                    node.superClass.type === 'Identifier' &&
                    ILLEGAL_GLOBAL_OBJECTS.has(node.superClass.name)
                ) {
                    context.report({
                        node,
                        message: `Directly extending the "${node.superClass.name}" global constructor causes an error to be thrown in IE11. Favor usage of prototypical inheritance.`,
                    });
                }
            },
        };
    },
};
