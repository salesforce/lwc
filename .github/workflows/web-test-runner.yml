name: Run Web Test Runner integration tests

on:
    push:
        branches:
            - master
            - release
            - 'spring*'
            - 'summer*'
            - 'winter*'
    pull_request:

env:
    SAUCE_USERNAME: ${{secrets.SAUCE_USERNAME}}
    SAUCE_ACCESS_KEY: ${{secrets.SAUCE_ACCESS_KEY}}
    GITHUB_RUN_ID: ${{github.run_id}}
    COVERAGE: '1'
    NODE_VERSION: '20.19.4'

jobs:
    # TODO: upload result artifacts
    integration-tests:
        name: Integration tests (${{ matrix.shadow_mode }} shadow)
        strategy:
            matrix:
                shadow_mode: [native, synthetic]

        runs-on: ubuntu-22.04
        env:
            SAUCE_TUNNEL_ID: github-action-tunnel-wtr-${{github.run_id}}-group-1
            SHADOW_MODE_OVERRIDE: ${{ matrix.shadow_mode }}
        defaults:
            run:
                working-directory: ./packages/@lwc/integration-not-karma
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'yarn'

            - name: Install dependencies
              run: yarn install --frozen-lockfile
              working-directory: ./

            - uses: saucelabs/sauce-connect-action@v3.0.0
              with:
                  username: ${{ secrets.SAUCE_USERNAME }}
                  accessKey: ${{ secrets.SAUCE_ACCESS_KEY }}
                  tunnelName: ${{ env.SAUCE_TUNNEL_ID }}
                  region: us

            - run: yarn test
            - run: API_VERSION=58 yarn test
            - run: API_VERSION=59 yarn test
            - run: API_VERSION=60 yarn test
            - run: API_VERSION=61 yarn test
            - run: API_VERSION=62 yarn test
            - run: API_VERSION=66 yarn test
            - run: DISABLE_NATIVE_CUSTOM_ELEMENT_LIFECYCLE=1 yarn test || true
            - run: DISABLE_STATIC_CONTENT_OPTIMIZATION=1 yarn test
            - run: ENABLE_ARIA_REFLECTION_GLOBAL_POLYFILL=1 yarn test
            - run: NODE_ENV_FOR_TEST=production yarn test

    integration-tests-not-both-modes:
        # Tests that should run in only synthetic or native shadow, not both
        name: Integration tests (singleton batch)
        runs-on: ubuntu-22.04
        env:
            SAUCE_TUNNEL_ID: github-action-tunnel-wtr-${{github.run_id}}-group-1
            SHADOW_MODE_OVERRIDE: ${{ matrix.shadow_mode }}
        defaults:
            run:
                working-directory: ./packages/@lwc/integration-not-karma
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'yarn'

            - name: Install dependencies
              run: yarn install --frozen-lockfile
              working-directory: ./

            - uses: saucelabs/sauce-connect-action@v3.0.0
              with:
                  username: ${{ secrets.SAUCE_USERNAME }}
                  accessKey: ${{ secrets.SAUCE_ACCESS_KEY }}
                  tunnelName: ${{ env.SAUCE_TUNNEL_ID }}
                  region: us

            # Synthetic shadow only
            - run: LEGACY_BROWSERS=1 yarn test || true
            - run: FORCE_NATIVE_SHADOW_MODE_FOR_TEST=1 yarn test
            - run: DISABLE_DETACHED_REHYDRATION=1 yarn test
            - run: DISABLE_NATIVE_CUSTOM_ELEMENT_LIFECYCLE=1 DISABLE_DETACHED_REHYDRATION=1 yarn test || true

            # Native shadow only -- don't forget SHADOW_MODE_OVERRIDE!
            - run: SHADOW_MODE_OVERRIDE=native DISABLE_SYNTHETIC_SHADOW_SUPPORT_IN_COMPILER=1 yarn test
            - run: SHADOW_MODE_OVERRIDE=native DISABLE_SYNTHETIC_SHADOW_SUPPORT_IN_COMPILER=1 DISABLE_STATIC_CONTENT_OPTIMIZATION=1 yarn test

    hydration-tests:
        runs-on: ubuntu-22.04
        env:
            SAUCE_TUNNEL_ID: github-action-tunnel-wtr-${{github.run_id}}-group-1
        defaults:
            run:
                working-directory: ./packages/@lwc/integration-not-karma
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'yarn'

            - name: Install dependencies
              run: yarn install --frozen-lockfile
              working-directory: ./

            - uses: saucelabs/sauce-connect-action@v3.0.0
              with:
                  username: ${{ secrets.SAUCE_USERNAME }}
                  accessKey: ${{ secrets.SAUCE_ACCESS_KEY }}
                  tunnelName: ${{ env.SAUCE_TUNNEL_ID }}
                  region: us
            - run: ENGINE_SERVER=1 yarn test:hydration
            - run: ENGINE_SERVER=1 SHADOW_MODE_OVERRIDE=synthetic yarn test:hydration
            - run: ENGINE_SERVER=1 NODE_ENV_FOR_TEST=production yarn test:hydration
            - run: ENGINE_SERVER=1 DISABLE_NATIVE_CUSTOM_ELEMENT_LIFECYCLE=1 yarn test:hydration
            - run: ENGINE_SERVER=1 DISABLE_STATIC_CONTENT_OPTIMIZATION=1 yarn test:hydration
            - run: ENGINE_SERVER=1 DISABLE_DETACHED_REHYDRATION=1 yarn test:hydration
            - run: ENGINE_SERVER=1 DISABLE_NATIVE_CUSTOM_ELEMENT_LIFECYCLE=1 DISABLE_DETACHED_REHYDRATION=1 yarn test:hydration
            - run: yarn test:hydration
            - run: SHADOW_MODE_OVERRIDE=synthetic yarn test:hydration
            - run: NODE_ENV_FOR_TEST=production yarn test:hydration
            - run: DISABLE_NATIVE_CUSTOM_ELEMENT_LIFECYCLE=1 yarn test:hydration
            - run: DISABLE_STATIC_CONTENT_OPTIMIZATION=1 yarn test:hydration
